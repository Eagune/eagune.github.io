---
title: （八）指令解析
date: 2020-05-16 20:42:31
categories:
- Vue深入理解
index: 8
tags:
- vue
- 指令
- 解析
photos: /imgs/vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%90.jpg
---

## compileDirectives

指令的解析和之前的文本解析差不多，我们都需要遍历节点最后执行`compileNode`，这里我们加一个判断如果节点是元素我们就进入我们的元素解析。

<!--more-->

``` javascript
function compileNode (node) {
  var type = node.nodeType
  if (type === 1) {
    return compileElement(node)
  } else if (type === 3 && node.data.trim()) {
    compileTextNode(node)
  }
}

function compileElement (el) {
  var linkFn
  var hasAttrs = el.hasAttributes()
  var attrs = hasAttrs && toArray(el.attributes)
  compileDirectives(el, attrs)
}

function compileDirectives (el, attrs) {
  var i = attrs.length
  var dirs = []
  var attr, name, rawName, rawValue, value, dirName, arg, dirDef, matched
  while (i--) {
    attr = attrs[i]
    name = rawName = attr.name
    value = rawValue = attr.value
    // 各种指令处理
  }
}
```

以上是一个大的结构，省略了指令的具体处理，后面我们对指令一个一个去分析。

## v-on指令

``` javascript
var onRE = /^v-on:|^@/
function compileDirectives (attrs) {
  ...

  if (onRE.test(name)) {
    arg = name.replace(onRE, '')
    var descriptor = {
      name: 'on',
      attr: rawName,
      raw: rawValue,
      def: publicDirectives.on,
      arg: arg,
      expression: value
    }
    new Directive(descriptor, el)
  } 
  
  ...
}

function on (el, event, cb, useCapture) {
  el.addEventListener(event, cb, useCapture)
}

var publicDirectives = {
  on: {
    update (handler) {
      if (!this.descriptor.raw) {
        handler = function () {}
      }
      var vm = this.vm
      this.handler = function (e) {
        return handler.call(vm, e)
      }
      on(this.el, this.arg, this.handler)
    },
  }
}
```

[查看DEMO](/demo/vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%901.html)

## v-bind指令

我们对不同bind的类型区分做处理：
1. 对于`value|checked|selected`等属性我们不仅需要修改属性的值同时我们还需要修改元素上对应的值
2. 对于`draggable|contenteditable|spellcheck`这种枚举型的值我们只允许`true`和`false`

其实v-bind指令还支持对象的形式，只是用的比较少这里也省略了。

``` javascript
var bindRE = /^v-bind:|^:/
function compileDirectives (attrs) {
  ...

  if (bindRE.test(name)) {
    dirName = name.replace(bindRE, '')
    arg = dirName
    var descriptor = {
      name: 'bind',
      attr: rawName,
      raw: rawValue,
      def: publicDirectives.bind,
      arg: arg,
      expression: value
    }
    new Directive(descriptor, el)
  }
  
  ...
}

var attrWithPropsRE = /^(?:value|checked|selected|muted)$/
var enumeratedAttrRE = /^(?:draggable|contenteditable|spellcheck)$/
var publicDirectives = {
  bind: {
    update (value) {
      var attr = this.arg
      if (this.arg) {
        this.handleSingle(attr, value)
      }
    },
    handleSingle (attr, value) {
      var el = this.el
      if (attrWithPropsRE.test(attr) && attr in el) {
        var attrValue = attr === 'value'
          ? value == null ? '' : value//IE9 will set input.value to "null" for null...
          : value
        if (el[attr] !== attrValue) {
          el[attr] = attrValue
        }
      }
      // do not set value attribute for textarea
      if (attr === 'value' && el.tagName === 'TEXTAREA') {
        el.removeAttribute(attr)
        return
      }
      // update attribute
      if (enumeratedAttrRE.test(attr)) {
        el.setAttribute(attr, value ? 'true' : 'false')
      } else if (value != null && value !== false) {
        el.setAttribute(attr, value === true ? '' : value)
      } else {
        el.removeAttribute(attr)
      }
    }
  }
}
```