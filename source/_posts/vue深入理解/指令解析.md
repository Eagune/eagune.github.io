---
title: （八）指令解析
date: 2020-05-16 20:42:31
categories:
- Vue深入理解
index: 8
tags:
- vue
- 指令
- 解析
photos: /imgs/vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%90.jpg
---

## compileDirectives

指令的解析和之前的文本解析差不多，我们都需要遍历节点最后执行compileNode，这里我们加一个判断如果节点是元素我们就进入我们的元素解析。

<!--more-->

``` javascript
function compileNode (node) {
  var type = node.nodeType
  if (type === 1) {
    return compileElement(node)
  } else if (type === 3 && node.data.trim()) {
    compileTextNode(node)
  }
}

function compileElement (el) {
  var linkFn
  var hasAttrs = el.hasAttributes()
  var attrs = hasAttrs && toArray(el.attributes)
  compileDirectives(el, attrs)
}

function compileDirectives (el, attrs) {
  var i = attrs.length
  var dirs = []
  var attr, name, rawName, rawValue, value, dirName, arg, dirDef, matched
  while (i--) {
    attr = attrs[i]
    name = rawName = attr.name
    value = rawValue = attr.value
    // 各种指令处理
  }
}
```

以上是一个大的结构，省略了指令的具体处理，后面我们对指令一个一个去分析。

## v-on指令

``` javascript
var onRE = /^v-on:|^@/
function compileDirectives (attrs) {
  ...

  if (onRE.test(name)) {
    arg = name.replace(onRE, '')
    pushDir('on', publicDirectives.on)
    var descriptor = {
      name: 'on',
      attr: rawName,
      raw: rawValue,
      def: publicDirectives.on,
      arg: arg,
      expression: value
    }
    new Directive(descriptor, el)
  } 
  
  ...
}

function on (el, event, cb, useCapture) {
  el.addEventListener(event, cb, useCapture)
}

var publicDirectives = {
  on: {
    update (handler) {
      if (!this.descriptor.raw) {
        handler = function () {}
      }
      var vm = this.vm
      this.handler = function (e) {
        return handler.call(vm, e)
      }
      on(this.el, this.arg, this.handler)
    },
  }
}
```

[查看DEMO](/demo/vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%901.html)