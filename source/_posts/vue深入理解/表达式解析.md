---
title: （六）表达式解析
date: 2020-05-09 22:33:25
categories:
- vue深入理解
index: 6
tags:
- vue
- 表达式解析
---

## parseText

``` javascript
function parseText (text) {
  var tagRE = /\{\{((?:.|\n)+?)\}\}/g
  // (?:.|\n)中，.匹配换行符以外的字符
  // 因为有的系统的换行符是\r\n
  // 所以.|\n匹配除了\r之外的任意字符
  // ?:表示非捕获型括号，所以整个的就是匹配任意一个非\r的字符

  if (!tagRE.test(text)) {
    return null
  }
  var tokens = []
  var lastIndex = tagRE.lastIndex = 0
  // 在正则中lastIndex属性用于规定下次匹配的起始位置
  // 因此我们每次匹配到后需要设置lastIndex为0下次才会匹配到正确的结果
  var match, index, html, value
  while (match = tagRE.exec(text)) {
    index = match.index
    // push text token
    if (index > lastIndex) {
      tokens.push({
        value: text.slice(lastIndex, index)
      })
    }
    // tag token
    value = match[1]
    tokens.push({
      tag: true,
      value: value.trim(),
    })
    lastIndex = index + match[0].length
  }
  if (lastIndex < text.length) {
    tokens.push({
      value: text.slice(lastIndex)
    })
  }
  return tokens
}

// 较源码省略了的地方：缓存、三重大括号显示html。
```

## compile

``` javascript
function compile (el) {
  var nodeLinkFn = compileNode(el, options)
  var childLinkFn = el.hasChildNodes()
    ? compileNodeList(el.childNodes, options)
    : null
}

function compileNodeList (nodeList, options) {
  var linkFns = []
  var nodeLinkFn, childLinkFn, node
  for (var i = 0, l = nodeList.length; i < l; i++) {
    node = nodeList[i]
    nodeLinkFn = compileNode(node, options)
    childLinkFn = node.hasChildNodes()
      ? compileNodeList(node.childNodes, options)
      : null
    linkFns.push(nodeLinkFn, childLinkFn)
  }
  return linkFns.length
    ? makeChildLinkFn(linkFns)
    : null
}

function compileNode (node, options) {
  var type = node.nodeType
  if (type === 3 && node.data.trim()) {
    return compileTextNode(node, options)
  } else {
    return null
  }
}

function compileTextNode (node, options) {
  var tokens = parseText(node.wholeText)
  if (!tokens) {
    return null
  }
  var frag = document.createDocumentFragment()
  var el, token
  for (var i = 0, l = tokens.length; i < l; i++) {
    token = tokens[i]
    el = token.tag
      ? processTextToken(token, options)
      : document.createTextNode(token.value)
    frag.appendChild(el)
  }
  return makeTextNodeLinkFn(tokens, frag, options)
}

function makeTextNodeLinkFn (tokens, frag) {
  return function textNodeLinkFn (vm, el, host, scope) {
    var fragClone = frag.cloneNode(true)
    var childNodes = Array.prototype.slice.call(fragClone.childNodes)
    var token, value, node
    for (var i = 0, l = tokens.length; i < l; i++) {
      token = tokens[i]
      value = token.value
      if (token.tag) {
        node = childNodes[i]
        vm._bindDir(token.descriptor, node, host, scope)
      }
    }
    replace(el, fragClone)
  }
}

function makeChildLinkFn (linkFns) {
  return function childLinkFn (vm, nodes, host, scope, frag) {
    var node, nodeLinkFn, childrenLinkFn
    for (var i = 0, n = 0, l = linkFns.length; i < l; n++) {
      node = nodes[n]
      nodeLinkFn = linkFns[i++]
      childrenLinkFn = linkFns[i++]
      var childNodes = Array.prototype.slice.call(node.childNodes)
      if (nodeLinkFn) {
        nodeLinkFn(vm, node, host, scope, frag)
      }
      if (childrenLinkFn) {
        childrenLinkFn(vm, childNodes, host, scope, frag)
      }
    }
  }
}
```
[查看DEMO](/demo/vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%A7%A3%E6%9E%90.html)